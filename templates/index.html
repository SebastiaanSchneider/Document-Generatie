<!doctype html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Report Generation</title>
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css">
    <style>
        /* Ensure the container takes up the full viewport height */
        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
            /* Prevent overall page scrolling */
        }

        /* Use Flexbox to make the layout responsive */
        .container-fluid {
            display: flex;
            flex-direction: column;
            height: 100vh;
            /* Full viewport height */
        }

        /* Adjust the height of the header and ensure it doesn't shrink */
        h1 {
            margin: 0;
            padding: 20px 0;
            text-align: center;
            flex-shrink: 0;
            /* Prevent header from shrinking */
        }

        /* Main content is flexed horizontally */
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: row;
            justify-content: space-between;
            height: calc(100vh - 80px);
            /* Adjust for header height */
        }

        /* Fixed width for the form column */
        .form-column {
            flex-basis: 250px;
            padding: 10px;
        }

        /* Flexbox for equal height columns for responses */
        .responses {
            display: flex;
            flex: 1;
            flex-direction: row;
            justify-content: space-between;
            align-items: stretch;
        }

        /* Each card should have the same width and height */
        .card {
            flex-grow: 1;
            margin: 10px;
            display: flex;
            flex-direction: column;
            height: 100%;
            /* Ensure cards take the full height */
            border: 2px solid #cccccc;
            /* More pronounced borders */
            transition: border-color 0.3s ease;
        }

        /* Darken the border on hover */
        .card:hover {
            border-color: #999999;
        }

        /* Card body adjusts based on header height */
        .card-body {
            flex-grow: 1;
            overflow: hidden;
        }

        /* Max height for scrolling within preview box */
        .preview-box {
            max-height: calc(100vh - 160px);
            /* Adjust for header and card header */
            overflow-y: auto;
            /* Enable vertical scrolling if content exceeds */
            white-space: pre-wrap;
            /* Ensure content wraps within the box */
        }

        /* Keep the cards at a consistent width */
        .col-md-4 {
            flex: 1;
            /* Equal width for each card */
            max-width: 33%;
            /* Limit the width to 1/3rd */
            display: flex;
            flex-direction: column;
            /* Ensure consistent height */
        }

        /* Align buttons in card-header to the right */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        /* Style for flash messages under the form */
        .flash-message {
            margin-top: 10px;
            color: green;
        }
    </style>
</head>

<body>
    <div class="container-fluid">
        <h1>Generate a Report for Dagbesteding</h1>

        <div class="main-content">
            <!-- Narrow column for the form -->
            <div class="form-column">
                <form method="POST">
                    <!-- Move "Select the client" above "Enter details for the report" -->
                    <div class="form-group">
                        <label for="client_name">Select the client:</label>
                        <select class="form-control" id="client_name" name="client_name" required>
                            {% for client in clients %}
                            <option value="{{ client.bijnaam }}">{{ client.bijnaam }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="input_text">Enter details for the report:</label>
                        <textarea class="form-control" id="input_text" name="input_text" rows="8" required></textarea>
                    </div>

                    <!-- "Genereer Rapport" button above "Voeg nieuwe client toe" -->
                    <button type="submit" class="btn btn-primary">Genereer Rapport</button>
                    <button type="button" class="btn btn-secondary mt-2" onclick="openNewClientModal()">Voeg nieuwe
                        client toe</button>

                    <!-- Flash message (does not affect layout) -->
                    {% if messages %}
                    <div class="flash-message">
                        {% for category, message in messages %}
                        <p>{{ message|safe }}</p>
                        {% endfor %}
                    </div>
                    {% endif %}
                </form>
            </div>

            <!-- Column for report previews -->
            <div class="responses">
                {% if generated_versions %}
                {% for temp, content in generated_versions.items() %}
                <div class="col-md-4">
                    <div class="card mb-3">
                        <div class="card-header">
                            <strong>Temperature {{ temp }}</strong>

                            <!-- Buttons in card-header -->
                            <div>
                                <button type="button" class="btn btn-warning btn-sm"
                                    onclick="openAdjustModal('{{ temp }}', '{{ client_name }}', '{{ user_input }}')">Aanpassen</button>
                                <button type="button" class="btn btn-secondary btn-sm"
                                    onclick="copyToClipboard('preview-box-{{ temp }}')">Copy to Clipboard</button>
                                <input type="hidden" name="content_{{ temp }}" value="{{ content }}">
                                <button type="button" class="btn btn-success btn-sm"
                                    onclick="saveDocx('{{ temp }}')">Save as DOCX</button>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="preview-box" id="preview-box-{{ temp }}">
                                {{ content }}
                            </div>
                        </div>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="text-center">No content generated yet. Fill out the form to create a report.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- New Client Modal -->
    <div class="modal fade" id="newClientModal" tabindex="-1" role="dialog" aria-labelledby="newClientModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="newClientModalLabel">Voeg nieuwe client toe</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="newClientForm">
                        <div class="form-group">
                            <label for="bijnaam">Bijnaam</label>
                            <input type="text" class="form-control" id="bijnaam" name="bijnaam" required>
                        </div>
                        <div class="form-group">
                            <label for="clientnummer">Clientnummer</label>
                            <input type="number" class="form-control" id="clientnummer" name="clientnummer" required>
                        </div>
                        <div class="form-group">
                            <label for="geslacht">Geslacht</label>
                            <select class="form-control" id="geslacht" name="geslacht" required>
                                <option value="Man">Man</option>
                                <option value="Vrouw">Vrouw</option>
                                <option value="Anders">Anders</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="leeftijd">Leeftijd</label>
                            <input type="number" class="form-control" id="leeftijd" name="leeftijd" required>
                        </div>
                        <div class="form-group">
                            <label for="woonplaats">Woonplaats</label>
                            <input type="text" class="form-control" id="woonplaats" name="woonplaats" required>
                        </div>
                        <div class="form-group">
                            <label for="locatie">Locatie</label>
                            <select class="form-control" id="locatie" name="locatie" required>
                                <option value="Alkmaar">Alkmaar</option>
                                <option value="Hoorn">Hoorn</option>
                                <option value="Purmerend">Purmerend</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-primary">Toevoegen</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- Adjust Modal -->
    <div class="modal fade" id="adjustModal" tabindex="-1" role="dialog" aria-labelledby="adjustModalLabel"
        aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="adjustModalLabel">Aanpassen van het verslag</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="adjustForm">
                        <div class="form-group">
                            <label for="adjustment">Wat zou u willen veranderen?</label>
                            <textarea class="form-control" id="adjustment" name="adjustment" rows="3"
                                required></textarea>
                        </div>
                        <input type="hidden" id="adjustTemp" name="temp" value="">
                        <input type="hidden" id="client_name" name="client_name" value="">
                        <input type="hidden" id="user_input" name="user_input" value="">
                        <button type="submit" class="btn btn-primary">Update</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript for Modal, Client Addition, and Clipboard Copy Function -->
    <script>
        function copyToClipboard(elementId) {
            const contentElement = document.getElementById(elementId);
            const tempElement = document.createElement('textarea');
            tempElement.value = contentElement.textContent;
            document.body.appendChild(tempElement);
            tempElement.select();
            document.execCommand('copy');
            document.body.removeChild(tempElement);
            alert("Copied to clipboard!");
        }

        function openAdjustModal(temp, clientName, userInput) {
            document.getElementById("adjustTemp").value = temp;
            document.getElementById("client_name").value = clientName;
            document.getElementById("user_input").value = userInput;
            $('#adjustModal').modal('show');
        }

        function openNewClientModal() {
            $('#newClientModal').modal('show');
        }

        document.getElementById('newClientForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const clientData = {
                bijnaam: document.getElementById('bijnaam').value,
                clientnummer: document.getElementById('clientnummer').value,
                geslacht: document.getElementById('geslacht').value,
                leeftijd: document.getElementById('leeftijd').value,
                woonplaats: document.getElementById('woonplaats').value,
                locatie: document.getElementById('locatie').value
            };

            fetch('/add_client', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(clientData)
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload(); // Reload to display new client in dropdown
                    } else {
                        alert('Failed to add client.');
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Handle submission of the adjustment form
        document.getElementById('adjustForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const temp = document.getElementById("adjustTemp").value;
            const adjustment = document.getElementById("adjustment").value;
            const clientName = document.getElementById("client_name").value;
            const userInput = document.getElementById("user_input").value;

            fetch(`/adjust_response/${temp}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    adjustment: adjustment,
                    client_name: clientName,
                    user_input: userInput
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`preview-box-${temp}`).textContent = data.updated_content;
                        $('#adjustModal').modal('hide');
                    } else {
                        alert('Failed to update the response.');
                    }
                })
                .catch(error => console.error('Error:', error));
        });

        // Function to save document as .docx without reloading the page
        function saveDocx(temp) {
            const content = document.querySelector(`input[name="content_${temp}"]`).value;

            fetch(`/save_docx/${temp}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: new URLSearchParams({ [`content_${temp}`]: content })
            })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        alert(`Report saved successfully. Download it here: ${data.file_url}`);
                    } else {
                        alert(data.message || 'Failed to save the document.');
                    }
                })
                .catch(error => console.error('Error:', error));
        }
    </script>

    <!-- JavaScript for Bootstrap (Optional) -->
    <script src="https://code.jquery.com/jquery-3.2.1.slim.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.11.0/umd/popper.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
</body>

</html>